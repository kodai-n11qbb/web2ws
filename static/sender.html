<!DOCTYPE html>
<html>
<head>
    <title>Web2WS Camera Sender</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        video { border: 2px solid #007bff; max-width: 100%; height: auto; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 0; cursor: pointer; }
        #status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .fps { font-size: 20px; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>üì∑ Camera Sender</h1>
    
    <div>
        <video id="video" autoplay muted playsinline style="max-width: 640px; border: 2px solid #007bff;"></video>
    </div>
    
    <div>
        <button id="startBtn">‚ñ∂Ô∏è Start Streaming</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Stop</button>
    </div>
    
    <div id="status" class="disconnected">
        üî¥ Not connected
    </div>
    
    <div class="fps">
        FPS: <span id="fpsCounter">0</span> | 
        Frames Sent: <span id="frameCounter">0</span>
    </div>

    <script>
        class CameraSender {
            constructor() {
                this.ws = null;
                this.video = document.getElementById('video');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.status = document.getElementById('status');
                this.fpsCounter = document.getElementById('fpsCounter');
                this.frameCounter = document.getElementById('frameCounter');
                
                this.stream = null;
                this.frameCount = 0;
                this.lastFpsTime = performance.now();
                this.fps = 0;
                this.totalFrames = 0;
                this.isStreaming = false;
                
                this.init();
            }
            
            async init() {
                this.startBtn.onclick = () => this.start();
                this.stopBtn.onclick = () => this.stop();
                
                // Request camera access
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 640 }, 
                            height: { ideal: 480 }, 
                            facingMode: 'user'
                        }
                    });
                    this.video.srcObject = this.stream;
                    this.updateStatus('üü° Camera ready - Click Start', 'connected');
                } catch (err) {
                    console.error('‚ùå Camera access failed:', err);
                    this.updateStatus('‚ùå Camera access denied', 'disconnected');
                    this.startBtn.disabled = true;
                }
            }
            
            start() {
                if (!this.stream) return;
                
                // Get dynamic hostname
                const host = window.location.hostname;
                const port = window.location.port || '9001';
                const wsUrl = `ws://${host}:${port}/camera`;
                
                this.ws = new WebSocket(wsUrl);
                this.ws.binaryType = 'arraybuffer';
                
                this.ws.onopen = () => {
                    console.log('‚úÖ Connected to camera endpoint:', wsUrl);
                    this.updateStatus('üü¢ Connected & Streaming', 'connected');
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.isStreaming = true;
                    this.startStreaming();
                };
                
                this.ws.onclose = () => {
                    console.log('üîå Disconnected from camera');
                    this.updateStatus('üî¥ Disconnected', 'disconnected');
                    this.isStreaming = false;
                };
                
                this.ws.onerror = (err) => {
                    console.error('‚ùå WebSocket error:', err);
                    this.updateStatus('‚ùå Connection failed', 'disconnected');
                    this.isStreaming = false;
                };
            }
            
            startStreaming() {
                const canvas = document.createElement('canvas');
                canvas.width = 640;
                canvas.height = 480;
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                const sendFrame = () => {
                    if (!this.isStreaming || !this.ws || this.ws.readyState !== WebSocket.OPEN) {
                        return;
                    }
                    
                    try {
                        ctx.drawImage(this.video, 0, 0, canvas.width, canvas.height);
                        // Convert to JPEG and send (optimize for speed: quality 0.75)
                        canvas.toBlob((blob) => {
                            if (blob && this.isStreaming && this.ws && this.ws.readyState === WebSocket.OPEN) {
                                blob.arrayBuffer().then(buffer => {
                                    this.ws.send(buffer);
                                    this.frameCount++;
                                    this.totalFrames++;
                                    this.updateFps();
                                });
                            }
                        }, 'image/jpeg', 0.75);
                    } catch (err) {
                        console.error('Error encoding frame:', err);
                    }
                    
                    // Send next frame (browser will throttle to monitor refresh rate)
                    requestAnimationFrame(sendFrame);
                };
                
                sendFrame();
            }
            
            stop() {
                this.isStreaming = false;
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.updateStatus('üî¥ Stopped', 'disconnected');
            }
            
            updateFps() {
                const now = performance.now();
                if (now - this.lastFpsTime >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFpsTime = now;
                }
                this.fpsCounter.textContent = this.fps.toString();
                this.frameCounter.textContent = this.totalFrames.toString();
            }
            
            updateStatus(message, className) {
                this.status.textContent = message;
                this.status.className = className;
            }
        }
        
        new CameraSender();
    </script>
</body>
</html>
