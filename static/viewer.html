<!DOCTYPE html>
<html>
<head>
    <title>Web2WS Viewer</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        #canvas { border: 2px solid #28a745; max-width: 100%; height: auto; background: #000; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 0; cursor: pointer; }
        #status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .fps { font-size: 20px; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ðŸ“º Video Viewer</h1>
    
    <div>
        <canvas id="canvas" width="640" height="480" style="border: 2px solid #28a745; background: #000;"></canvas>
    </div>
    
    <div>
        <button id="connectBtn">ðŸ”— Connect</button>
        <button id="disconnectBtn" disabled>ðŸ”Œ Disconnect</button>
    </div>
    
    <div id="status" class="disconnected">
        ðŸ”´ Disconnected
    </div>
    
    <div class="fps">
        FPS: <span id="fpsCounter">0</span> | 
        Frames: <span id="frameCounter">0</span>
    </div>

    <script>
        class VideoViewer {
            constructor() {
                this.ws = null;
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.connectBtn = document.getElementById('connectBtn');
                this.disconnectBtn = document.getElementById('disconnectBtn');
                this.status = document.getElementById('status');
                this.fpsCounter = document.getElementById('fpsCounter');
                this.frameCounter = document.getElementById('frameCounter');
                
                this.frameCount = 0;
                this.lastFpsTime = performance.now();
                this.fps = 0;
                this.totalFrames = 0;
                
                this.init();
            }
            
            init() {
                this.connectBtn.onclick = () => this.connect();
                this.disconnectBtn.onclick = () => this.disconnect();
            }
            
            connect() {
                // localhost or dynamic hostname
                const host = window.location.hostname;
                const port = window.location.port || '9001';
                const wsUrl = `ws://${host}:${port}/view`;
                
                this.ws = new WebSocket(wsUrl);
                this.ws.binaryType = 'arraybuffer';
                
                this.ws.onopen = () => {
                    console.log('âœ… Viewer connected to', wsUrl);
                    this.updateStatus('ðŸŸ¢ Connected & Receiving', 'connected');
                    this.connectBtn.disabled = true;
                    this.disconnectBtn.disabled = false;
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        // Receive binary JPEG frame data
                        const arrayBuffer = event.data;
                        const blob = new Blob([arrayBuffer], { type: 'image/jpeg' });
                        const url = URL.createObjectURL(blob);
                        
                        const img = new Image();
                        img.onload = () => {
                            // Draw JPEG to canvas (fast)
                            this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
                            URL.revokeObjectURL(url);
                            
                            this.frameCount++;
                            this.totalFrames++;
                            this.updateFps();
                        };
                        img.onerror = () => {
                            URL.revokeObjectURL(url);
                            console.warn('Failed to decode JPEG frame');
                        };
                        img.src = url;
                    } catch (err) {
                        console.error('Frame processing error:', err);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('ðŸ”Œ Viewer disconnected');
                    this.updateStatus('ðŸ”´ Disconnected', 'disconnected');
                    this.reset();
                };
                
                this.ws.onerror = (err) => {
                    console.error('Viewer error:', err);
                    this.updateStatus('âŒ Connection failed', 'disconnected');
                };
            }
            
            disconnect() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                this.reset();
            }
            
            reset() {
                this.connectBtn.disabled = false;
                this.disconnectBtn.disabled = true;
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }
            
            updateFps() {
                const now = performance.now();
                if (now - this.lastFpsTime >= 1000) {
                    this.fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFpsTime = now;
                }
                this.fpsCounter.textContent = this.fps.toString();
                this.frameCounter.textContent = this.totalFrames.toString();
            }
            
            updateStatus(message, className) {
                this.status.textContent = message;
                this.status.className = className;
            }
        }
        
        new VideoViewer();
    </script>
</body>
</html>
